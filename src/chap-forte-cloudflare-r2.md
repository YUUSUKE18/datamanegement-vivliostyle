---
class: chapter
---

# Podcast音源配信にCloudFlare R2を使う

<div class="flush-right">
FORTE(フォルテ)@FORTEgp05
</div>

本章の執筆をしましたFORTE(フォルテ)と申します。この記事ではPodcastの音源(MP3)配信にCloudFlare R2というサービスを使用した話を紹介したいと思います。

昨今では音楽生成AIによって生成したMP3ファイルを気軽に配信したいと思うかもしれません。そんな時にご一読いただければ幸いです。

なお、これはZennにアップした記事<span class="footnote">https://zenn.dev/forte/articles/cc5b98508c2eda</span>を元に後日談を加筆したり修正したものになります。

![元となったZenn記事](./images/chap-forte/chap-forte/r2_004.png)

## Podcast配信サイトを自分で作成可能なYattecast
私はaozora.fm<span class="footnote">https://fortegp05.github.io/aozorafm/</span>というPodcastを配信しています。

![仕事や趣味の楽しさを共有する雑談系Podcast aozora.fm](./images/chap-forte/chap-forte/r2_001.png)

これはYattecast<span class="footnote">https://r7kamura.github.io/yattecast/</span>というテンプレートを改造したPodcast配信ページです。

![Podcastサイトをつくるためのテンプレート Yattecast](./images/chap-forte/chap-forte/r2_002.png)

昨今はSpotifyやListenなどさまざまで手軽にPodcastを配信できるサービスが増えてきました。しかし一方でそれらのサイトでは見た目が同じようになってしまう、好きに改造できないというデメリットもあります。

aozora.fmはデザインや機能追加をできるようにYattecastで使用しています。

## GitHub Pagesの仕様変更により新EP公開に時間がかかるように
YattecastはGithub Pagesを利用しており、2021年8月末まではGithub PagesのデプロイにGithub Actionsは使われておらずデプロイ時間もさほどかかっていませんでした。

しかし、2023年11月末にGithub Pagesを更新したところ、デプロイにGithub Actionsが使われるようになっていました。Github Pagesの設定でBuild and deploymentをDeploy from a branchにしていてもGithub Actionsが動きます。

Github PagesのGithub Actionsは毎回リポジトリ内の全てのファイルをアーカイブしアップロードします。これがテキストや画像数枚だけのサイトなら問題ありません。

しかし、Podcast配信サイトとなると1エピソードにつき数十MBのMP3ファイルが含まれるため、エピソード数が多くなればなるほどそこそこのサイズのMP3ファイルがアーカイブ、アップロードされるようになり、デプロイに時間がかかるようになります。

甚爾のaozora.fmでは86エピソード、合計3.77GBのMP3ファイルが存在し、デプロイに30分前後かかるようになっていました。

![改善後、現在のデプロイ時間(30分前後が40秒前後に！)](./images/chap-forte/chap-forte/r2_003.png)

今回はこのデプロイ時間が長いという問題を解消した顛末を紹介します。ほとんどいないと思いますが、YattecastでPodcastを配信している方、これから配信しようとしている方に向けて参考になれば幸いです。


## 問題のサマリ
 - 問題
    - Github Pagesのデプロイに時間がかかる(30分前後)
 - Github Pagesのアーティファクトサイズの上限である1GBを超えてしまう
    - 警告は出るがデプロイはできる
    - しかし、いつデプロイできなくなるかは分からない
 - 解決策
    - サイズが大きいファイル(今回はMP3ファイル)を別サーバーへ移動
 - 結果
    - 30分前後かかっていたデプロイ時間が、40秒程度に短縮
    - 約3.7GBあったアーティファクトサイズが、約3MBに減少
 - 費用
    - ドメイン料に年間約600円

## 対策
対策について詳細な流れを紹介します。

もし同じような問題に遭遇した時の考え方の参考になれば幸いです。

### 経緯
デプロイに時間がかかると分かってから3回、合計4回デプロイした時点でこれは対処しないとストレスフルだと判断しました。なにせ、Podcast公開後に誤字脱字を1文字直すだけでも毎回全てのファイルをアーカイブしアップロードするため、公開まで30分待つ必要があります。

またGithub PagesにMP3ファイルを配置しているとデプロイが終わらなければ正常に再生できるかどうか分からず、約30分待ってちゃんと配信できたかどうか確認するはめになっていました。

### 対策案の検討
いくつか対策案を検討しましたので、その案を紹介します。

#### Github Actionsの設定見直し
まずGithub Pagesにデプロイする際のGithub Actionsの設定を変更し、差分デプロイが可能がどうか調べてみました。

しかし、調べてみても差分だけデプロイ・アップロードする方法は見つかりませんでした。

差分を検知する方法、差分だけテストする方法などはありましたが、デプロイ対象を差分だけにする方法は見つかりませんでした。

もし、この記事をご覧の方でGithub Actionsの差分デプロイ方法をご存じの方がいればコメントなどでご教授いただけると幸いです。

#### 知人に相談しGoogle Driveを使ってみる
次に知り合いが集まるITエンジニアコミュニティに相談し、解決策がないか相談してみました。何も案がない相談では投げやりすぎるので以下の案で相談しています。

1. CloudFlareでドメインを購入してWebサイトなりWebストレージなりを使う
2. Google Driveを使う
3. Podcastの配信サイトを変更する
4. 諦めてデプロイ時間を受け入れる
5. その他、なにか良い案があれば教えていただきたい

この時点で個人的には無料だしGoogle Driveかなと思っていました。

相談に乗ってくれたITエンジニアは2人で、両人ともGoogle Driveがよいと言ってくれたのでGoogle Driveを試してみました。

しかしGoogle DriveにアップロードしたMP3ファイルを共有して得られたリンクをPodcastに埋め込むと、MP3として認識されず、Google Drive専用のViewページが表示されてしまいました。

これでは音源のダウンロードができても配信ページで再生できないため、NGです。

というわけで、Google Drive案はボツになりました。

#### さらに助言を募っての結論
Google Driveはダメだったとの報告を兼ねて、さらに助言を募ったところ、さくらのVPSをオススメされました。そのときに確認すると最低構成にすれば月額319円<span class="footnote">確認当時の金額、元になった記事を書いている時点では590円になっていました</span>で運用できそうでした。

この時点で無料で解決するのはほぼ諦めており、どのサービスが一番安いか?に関心が移っていました。

比較すると次のようになります。

 - CloudFlareで1番安いドメインを購入すると年額約600円
 - さくらのVPSで一番安い構成だと年額約3600円

CloudFlareは無料枠がありますが、超過すると課金されてしまう可能性があります。またストレージサイズの上限が10GBなのがボトルネックになります。

ですが、約5年間配信してきて3.7GBであり、仮に10GBを超過ても1GB2円とかなのでドメイン量に比べればわずかな値段なので問題にはならないと判断しました。

その他、バケットへの操作も月に100万、1,000万リクエストが無料の上限ですが、場末の弊Podcastではそこまでいくことはなさそうです。

というわけで最も安いCloudFlareで運用することにしました。

### CloudFlare R2の導入
導入方法に関してはググれば出てくるのと、日本語で操作できるのでここでは詳細に紹介しません。

唯一ハマった点としては支払い方法として選択可能なPayPalが選択できず、クレジットカードじゃないと登録できなかったことです。

PayPalを選択してOKを押しても画面を更新すると無かったことになっており、特にエラーメッセージもなかったので調べ様もなく、解決できませんでした。

あとはドメインの購入(.winが安くてオススメです)、R2のバケット作成、ドメインの適用、MP3ファイルのアップロードをするだけで準備完了です。

### Yattecastの改修
デフォルトではMP3のファイルパスはGithub Pagesにデプロイされたaudioフォルダ配下を参照しています。これはyattecast/_layouts/article.htmlのaudioタグの中で以下のように指定されています。

```
src="{{ page.audio_file_path | prepend:site.github.url }}"
```

ここで prepend:site.github.url はGithubPagesのURLを示しているので、CloudFlareに載せ替える際はこれを削除します。すると次のようになります。

```
src="{{ page.audio_file_path }}"
```

このpage.audio_file_path はyattecast/_posts配下にあるマークダウンファイル(例:2016-11-10-1.md)内のaudio_file_pathという項目にあたります。ここにCloudFlareに配置したMP3ファイルのURLを指定すればCloudFlareからMP3ファイルを配信できます。

あとはaudioフォルダ内のMP3を削除してcommit、pushし、デプロイが成功すれば完了です。

## 運用して1年が経った
CloudFlare R2を利用し始めて1年以上経ちました。

だいたい1週間に1回はPodcastを配信していますが、R2の利用料金がかかったことはありません。定期的に請求メールが来ますがずっと0$です。

ただ現在のストレージ使用量は5.22GBと、1.5GBほど増えています。とはいえまだ数年は余裕がありそうですし、数年後に突然ストレージ使用料が数千円になったりはしないと思っています。

そのため上限に近づいてから考えても遅くはないかなと思います。

総合してCloudFlare R2を選択したのは大正解だったなと思います。いまのところ大満足です。

## さいごに
というわけでGithub Pagesのデプロイ速度改善にCloudFlare R2を導入した顛末を記事にしてみました。相談に乗っていただいた方に報告するために、Yattecastで同じ悩みがある方のお役に立てばと思い書いてみました。

費用としてドメイン代金が年額600円かかるようになってしまいましたが、投資効果としては十分すぎるかなと思います。

無料であることに越したことはないですが、0円にこだわって先に進まないよりも、費用をかけてもその分の効果があると実感できれば良いと思います。お金を稼ぐ方法は他にいくらでもありますしね。

この記事が何かの役に立つことを願って。
